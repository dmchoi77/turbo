name: Test pnpm Store Cache (Failure Scenario)

on:
  workflow_dispatch:
    inputs:
      scenario:
        description: "Failure scenario to test (1-5)"
        required: false
        default: "3"
        type: choice
        options:
          - "1"
          - "2"
          - "3"
          - "4"
          - "5"

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: test-pnpm-cache-fail

permissions:
  id-token: write
  contents: read

jobs:
  test-pnpm-cache-fail:
    name: üß™ Test pnpm Store Cache (Failure Scenario ${{ inputs.scenario }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Cache pnpm store
        id: pnpm-cache
        uses: actions/cache@v3
        with:
          path: pnpm
          key: ${{ runner.os }}-pnpm-test-fail-${{ inputs.scenario }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-test-fail-${{ inputs.scenario }}-

      - name: Inject cache into Docker
        uses: reproducible-containers/buildkit-cache-dance@v3
        with:
          cache-map: |
            {
              "pnpm": "/pnpm"
            }
          skip-extraction: ${{ steps.pnpm-cache.outputs.cache-hit != 'true' }}
          builder: ${{ steps.buildx.outputs.name }}

      - name: Determine target stage for scenario
        id: scenario-stage
        run: |
          SCENARIO=${{ inputs.scenario || '3' }}
          echo "Testing failure scenario $SCENARIO"
          
          # Í∞Å ÏãúÎÇòÎ¶¨Ïò§Ïóê Ìï¥ÎãπÌïòÎäî ÏµúÏ¢Ö Ïä§ÌÖåÏù¥ÏßÄ Í≤∞Ï†ï
          case $SCENARIO in
            1)
              TARGET_STAGE="installer-no-id"
              DESCRIPTION="No ID specified (cache sharing may be unstable)"
              ;;
            2)
              TARGET_STAGE="builder-different-id"
              DESCRIPTION="Different IDs per stage (cache not shared)"
              ;;
            3)
              TARGET_STAGE="runner-no-mount"
              DESCRIPTION="No cache mount in final stage (extraction fails)"
              ;;
            4)
              TARGET_STAGE="runner-no-cache-mount-final"
              DESCRIPTION="Regular directory instead of cache mount (extraction fails)"
              ;;
            5)
              TARGET_STAGE="runner-wrong-id"
              DESCRIPTION="Different ID in final stage (extracts empty cache)"
              ;;
            *)
              TARGET_STAGE="runner-no-mount"
              DESCRIPTION="Default: No cache mount in final stage"
              ;;
          esac
          
          echo "target-stage=$TARGET_STAGE" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "Using target stage: $TARGET_STAGE"
          echo "Scenario: $DESCRIPTION"

      - name: Build Docker image (failure scenario)
        id: docker-build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./dockerfiles/test-pnpm-cache-fail-scenario.dockerfile
          target: ${{ steps.scenario-stage.outputs.target-stage }}
          tags: |
            test-pnpm-cache-fail:${{ inputs.scenario || '3' }}
          # outputs: type=docker,dest=/tmp/test-image.tar

      - name: Extract cache from Docker (Expected to Fail)
        id: extract-cache
        continue-on-error: true
        uses: reproducible-containers/buildkit-cache-dance@v3
        with:
          cache-map: |
            {
              "pnpm": "/pnpm"
            }
          builder: ${{ steps.buildx.outputs.name }}

      - name: Check extracted cache size
        id: check-cache-size
        run: |
          echo "Checking extracted cache size..."
          if [ -d "pnpm" ]; then
            CACHE_SIZE=$(du -sh pnpm 2>/dev/null | cut -f1)
            CACHE_FILES=$(find pnpm -type f 2>/dev/null | wc -l)
            echo "Cache directory exists"
            echo "Cache size: $CACHE_SIZE"
            echo "Cache files: $CACHE_FILES"
            
            # Îπà Ï∫êÏãúÏù∏ÏßÄ ÌôïÏù∏ (ÌååÏùºÏù¥ Í±∞Ïùò ÏóÜÍ±∞ÎÇò ÌÅ¨Í∏∞Í∞Ä Îß§Ïö∞ ÏûëÏùå)
            if [ "$CACHE_FILES" -lt 10 ] || [ -z "$(find pnpm -type f -size +1k 2>/dev/null | head -1)" ]; then
              echo "cache-empty=true" >> $GITHUB_OUTPUT
              echo "‚ö†Ô∏è Extracted cache is empty or very small"
            else
              echo "cache-empty=false" >> $GITHUB_OUTPUT
              echo "‚úÖ Extracted cache has content"
            fi
          else
            echo "cache-empty=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Cache directory does not exist"
          fi

      - name: Check extraction result
        run: |
          echo "Scenario: ${{ steps.scenario-stage.outputs.description }}"
          echo "Target stage: ${{ steps.scenario-stage.outputs.target-stage }}"
          echo ""
          
          # Ï∫êÏãú Ï∂îÏ∂ú Îã®Í≥ÑÍ∞Ä Ïã§Ìå®ÌñàÍ±∞ÎÇò, Îπà Ï∫êÏãúÍ∞Ä Ï∂îÏ∂úÎêú Í≤ΩÏö∞ ÏÑ±Í≥µÏúºÎ°ú Ï≤òÎ¶¨
          if [ "${{ steps.extract-cache.outcome }}" == "failure" ]; then
            echo "‚úÖ Expected: Cache extraction failed as intended"
            echo "This confirms that failure scenario ${{ inputs.scenario || '3' }} is working correctly"
            echo ""
            echo "The cache extraction failed because:"
            echo "- The final stage does not have /pnpm mounted"
            echo "- buildkit-cache-dance cannot extract from an unmounted directory"
          elif [ "${{ steps.check-cache-size.outputs.cache-empty }}" == "true" ]; then
            echo "‚úÖ Expected: Cache extraction succeeded but cache is empty"
            echo "This confirms that failure scenario ${{ inputs.scenario || '3' }} is working correctly"
            echo ""
            echo "The cache extraction 'succeeded' but extracted an empty cache because:"
            echo "- The final stage does not have /pnpm mounted with actual cache content"
            echo "- buildkit-cache-dance extracted an empty directory"
            echo ""
            echo "This is the expected behavior for failure scenarios."
          else
            echo "‚ùå Unexpected: Cache extraction succeeded with actual content"
            echo "The failure scenario may not be configured correctly"
            echo ""
            echo "Expected behavior: Cache extraction should fail OR extract empty cache"
            echo "Actual behavior: Cache extraction succeeded with content"
            exit 1
          fi

      - name: Clean up temporary build image file
        if: always()
        run: |
          if [ -f /tmp/test-image.tar ]; then
            echo "Removing temporary build image file to free up disk space..."
            rm -f /tmp/test-image.tar
            echo "Temporary file removed"
          fi

