name: Bundle Size Analyzer

on:
  push:
    branches: [main, master]
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Job 1: Main branch - Save stats.json as artifact
  save-main-stats:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.6.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Detect changed Next.js apps
        id: changed-apps
        run: |
          # Get the previous commit to compare against
          PREV_SHA=$(git rev-parse HEAD^1 2>/dev/null || echo "")
          CHANGED_APPS=""

          if [ -n "$PREV_SHA" ]; then
            CHANGED_APPS=$(pnpm turbo list --filter="[${PREV_SHA}]..." --json 2>/dev/null | jq -r '.[] | select(.task == "build") | .package' | grep -E "^(apps/docs|apps/web)$" || true)
          fi

          # If no changes detected or turbo list failed, check all Next.js apps
          if [ -z "$CHANGED_APPS" ]; then
            echo "No changes detected or first build - building all Next.js apps"
            CHANGED_APPS="apps/docs apps/web"
          fi

          # Filter out apps that don't exist
          EXISTING_APPS=""
          for app in $CHANGED_APPS; do
            if [ -d "$app" ]; then
              if [ -z "$EXISTING_APPS" ]; then
                EXISTING_APPS="$app"
              else
                EXISTING_APPS="$EXISTING_APPS $app"
              fi
            else
              echo "Skipping $app - directory does not exist"
            fi
          done

          if [ -z "$EXISTING_APPS" ]; then
            echo "No Next.js apps found, skipping..."
            echo "apps=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "apps=$EXISTING_APPS" >> $GITHUB_OUTPUT
          echo "Changed apps: $EXISTING_APPS"

      - name: Build with analysis
        env:
          ANALYZE: "true"
        run: |
          for app in ${{ steps.changed-apps.outputs.apps }}; do
            echo "Building $app..."
            app_name=$(basename $app)
            pnpm turbo build --filter="./$app" --env-mode=strict || \
            pnpm turbo build --filter="$app_name" --env-mode=strict
          done

      - name: Collect stats.json files
        id: collect-stats
        run: |
          mkdir -p bundle-stats
          has_files=false
          for app in ${{ steps.changed-apps.outputs.apps }}; do
            app_name=$(basename $app)
            if [ -f "$app/.next/stats.json" ]; then
              cp "$app/.next/stats.json" "bundle-stats/${app_name}-stats.json"
              echo "Saved stats for $app_name"
              has_files=true
            else
              echo "Warning: stats.json not found for $app_name at $app/.next/stats.json"
            fi
          done

          if [ "$has_files" = "true" ]; then
            echo "has_stats=true" >> $GITHUB_OUTPUT
            echo "Stats files collected:"
            ls -la bundle-stats/
          else
            echo "has_stats=false" >> $GITHUB_OUTPUT
            echo "No stats files to cache"
          fi

      - name: Cache main branch stats
        if: steps.collect-stats.outputs.has_stats == 'true'
        uses: actions/cache@v4
        with:
          path: bundle-stats/
          key: bundle-stats-main-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            bundle-stats-main-${{ github.ref_name }}-
            bundle-stats-main-

  # Job 2: PR - Compare and comment
  compare-bundles:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: []

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.6.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Detect changed Next.js apps
        id: changed-apps
        run: |
          git fetch origin ${{ github.base_ref }}:origin/${{ github.base_ref }} || true

          echo "=== Changed files ==="
          git diff --name-only origin/${{ github.base_ref }}...HEAD || true
          echo "===================="

          CHANGED_APPS=""

          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^apps/web/"; then
            CHANGED_APPS="apps/web"
            echo "âœ“ apps/web has changes"
          fi

          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^apps/docs/"; then
            if [ -n "$CHANGED_APPS" ]; then
              CHANGED_APPS="$CHANGED_APPS apps/docs"
            else
              CHANGED_APPS="apps/docs"
            fi
            echo "âœ“ apps/docs has changes"
          fi

          # If no changes detected, check if apps exist and build all
          if [ -z "$CHANGED_APPS" ]; then
            echo "No changes detected via git diff, checking if apps exist..."
            if [ -d "apps/web" ]; then
              CHANGED_APPS="apps/web"
              echo "Building apps/web (no changes detected but app exists)"
            fi
            if [ -d "apps/docs" ]; then
              if [ -n "$CHANGED_APPS" ]; then
                CHANGED_APPS="$CHANGED_APPS apps/docs"
              else
                CHANGED_APPS="apps/docs"
              fi
              echo "Building apps/docs (no changes detected but app exists)"
            fi
          fi

          if [ -z "$CHANGED_APPS" ]; then
            echo "No Next.js apps found, skipping..."
            echo "apps=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "apps=$CHANGED_APPS" >> $GITHUB_OUTPUT
          echo "Final changed apps: $CHANGED_APPS"

      - name: Check if any apps changed
        if: steps.changed-apps.outputs.apps == ''
        run: |
          echo "No Next.js apps changed, exiting..."
          exit 0

      - name: Get main branch commit SHA
        id: main-sha
        run: |
          git fetch origin ${{ github.base_ref }}:origin/${{ github.base_ref }} || true
          MAIN_SHA=$(git rev-parse origin/${{ github.base_ref }} 2>/dev/null || echo "")
          echo "main_sha=$MAIN_SHA" >> $GITHUB_OUTPUT
          echo "Main branch SHA: $MAIN_SHA"

      - name: Restore main branch stats from cache
        id: cache-main-stats
        uses: actions/cache@v4
        with:
          path: main-stats
          key: bundle-stats-main-${{ steps.main-sha.outputs.main_sha }}
          restore-keys: |
            bundle-stats-main-

      - name: Check if main stats cached
        id: check-stats
        run: |
          if [ -d "main-stats" ] && [ "$(ls -A main-stats 2>/dev/null)" ]; then
            echo "has_main_stats=true" >> $GITHUB_OUTPUT
            echo "âœ“ Main branch stats found from cache"
            ls -la main-stats/
          else
            echo "has_main_stats=false" >> $GITHUB_OUTPUT
            echo "â„¹ Main branch stats not found in cache - will build main branch for comparison"
            mkdir -p main-stats
          fi

      - name: Build main branch for comparison
        if: steps.check-stats.outputs.has_main_stats != 'true'
        run: |
          CURRENT_REF=$(git rev-parse HEAD)
          git fetch origin ${{ github.base_ref }} --depth=1
          git checkout -b temp-main-branch FETCH_HEAD
          pnpm install

          mkdir -p main-stats
          for app in ${{ steps.changed-apps.outputs.apps }}; do
            if [ ! -d "$app" ]; then
              echo "Skipping $app - does not exist on main branch"
              continue
            fi
            app_name=$(basename $app)
            echo "Building $app on main branch..."
            
            # Try to build with ANALYZE=true
            if ANALYZE=true pnpm turbo build --filter="./$app" --env-mode=strict; then
              echo "âœ“ Built $app successfully"
            elif ANALYZE=true pnpm turbo build --filter="$app_name" --env-mode=strict; then
              echo "âœ“ Built $app successfully"
            else
              echo "âœ— Failed to build $app on main branch"
              continue
            fi
            
            # Check if stats.json was created
            if [ -f "$app/.next/stats.json" ]; then
              cp "$app/.next/stats.json" "main-stats/${app_name}-stats.json"
              echo "âœ“ Copied stats.json for $app_name"
            else
              echo "âœ— stats.json not found for $app_name"
              echo "  Checking $app/.next/ directory:"
              ls -la "$app/.next/" 2>/dev/null || echo "  .next directory does not exist"
              echo "  Looking for stats.json in $app:"
              find "$app" -name "stats.json" 2>/dev/null || echo "  No stats.json found"
            fi
          done

          echo "Main stats files:"
          ls -la main-stats/ || echo "No stats files found"
          
          # Check if any stats were collected
          if [ ! -d "main-stats" ] || [ -z "$(ls -A main-stats 2>/dev/null)" ]; then
            echo "âš ï¸ Warning: No stats files collected from main branch build"
          fi

          git checkout $CURRENT_REF

      - name: Cache main branch stats (if built)
        if: steps.check-stats.outputs.has_main_stats != 'true'
        uses: actions/cache@v4
        with:
          path: main-stats
          key: bundle-stats-main-${{ steps.main-sha.outputs.main_sha }}
          restore-keys: |
            bundle-stats-main-

      - name: Verify main stats
        id: verify-stats
        run: |
          if [ -d "main-stats" ] && [ "$(ls -A main-stats 2>/dev/null)" ]; then
            echo "has_main_stats=true" >> $GITHUB_OUTPUT
          else
            echo "has_main_stats=false" >> $GITHUB_OUTPUT
          fi

      - name: Build PR branch with analysis
        env:
          ANALYZE: "true"
        run: |
          # Ensure dependencies are installed
          pnpm install

          for app in ${{ steps.changed-apps.outputs.apps }}; do
            echo "Building $app..."
            app_name=$(basename $app)
            pnpm turbo build --filter="./$app" --env-mode=strict || \
            pnpm turbo build --filter="$app_name" --env-mode=strict
          done

      - name: Compare bundles and generate report
        id: compare
        run: |
          mkdir -p comparison-results
          all_comparisons=""
          has_main_stats=${{ steps.verify-stats.outputs.has_main_stats }}

          echo "=== Debug Info ==="
          echo "has_main_stats: $has_main_stats"
          echo "Changed apps: ${{ steps.changed-apps.outputs.apps }}"
          echo "=================="

          for app in ${{ steps.changed-apps.outputs.apps }}; do
            app_name=$(basename $app)
            main_stats="main-stats/${app_name}-stats.json"
            pr_stats="${app}/.next/stats.json"
            
            echo "Processing $app_name..."
            echo "  PR stats path: $pr_stats"
            echo "  Main stats path: $main_stats"
            
            if [ ! -f "$pr_stats" ]; then
              echo "  âœ— PR stats not found for $app_name at $pr_stats, skipping"
              continue
            fi
            echo "  âœ“ PR stats found"
            
            if [ "$has_main_stats" != "true" ] || [ ! -f "$main_stats" ]; then
              echo "Main stats not available for $app_name"
              echo "This might be the first build or main branch stats are not available yet."
              echo "Showing PR bundle size only for $app_name"
              
              # Generate stats summary without comparison
              pr_size=$(node -e "
                const fs = require('fs');
                const stats = JSON.parse(fs.readFileSync('$pr_stats', 'utf-8'));
                let total = 0;
                if (stats.chunks) {
                  stats.chunks.forEach(chunk => {
                    if (chunk.parsedSize !== undefined) {
                      total += chunk.parsedSize;
                    } else if (chunk.size) {
                      total += chunk.size;
                    }
                  });
                }
                console.log((total / 1024).toFixed(2));
              ")
              
              comparison="## ðŸ“¦ Bundle Size Analysis - $app_name\n\n"
              comparison+="âš ï¸ **Main branch stats not available** - This might be the first PR or main branch hasn't been built yet.\n\n"
              comparison+="**Current PR Bundle Size:** ${pr_size} KB\n\n"
              comparison+="*Note: Comparison will be available after main branch is built.*"
              
              echo "$comparison" > "comparison-results/${app_name}.md"
              
              if [ -z "$all_comparisons" ]; then
                all_comparisons="$comparison"
              else
                all_comparisons="$all_comparisons\n\n---\n\n$comparison"
              fi
              continue
            fi
            
            echo "Comparing $app_name..."
            comparison=$(node scripts/compare-bundles.js "$main_stats" "$pr_stats")
            echo "$comparison" > "comparison-results/${app_name}.md"
            
            if [ -z "$all_comparisons" ]; then
              all_comparisons="$comparison"
            else
              all_comparisons="$all_comparisons\n\n---\n\n$comparison"
            fi
          done

          echo "=== Final Check ==="
          echo "all_comparisons length: ${#all_comparisons}"
          if [ -z "$all_comparisons" ]; then
            echo "No comparisons generated"
            echo "has_comparison=false" >> $GITHUB_OUTPUT
            echo "comparison=" >> $GITHUB_OUTPUT
          else
            echo "Comparisons generated successfully"
            echo "has_comparison=true" >> $GITHUB_OUTPUT
            # Escape for multiline output
            {
              echo 'comparison<<EOF'
              echo "$all_comparisons"
              echo 'EOF'
            } >> $GITHUB_OUTPUT
          fi

      - name: Find existing comment
        if: steps.compare.outputs.has_comparison == 'true'
        uses: actions/github-script@v7
        id: find-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(
              (comment) =>
                comment.user.type === 'Bot' &&
                comment.body.includes('Bundle Size Comparison')
            );

            core.setOutput('result', botComment?.id || '');

      - name: Create or update PR comment
        if: steps.compare.outputs.has_comparison == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentBody = `${{ steps.compare.outputs.comparison }}`.trim();
            const existingCommentId = `${{ steps.find-comment.outputs.result }}`.trim();

            if (!commentBody) {
              console.log('No comment body to post');
              return;
            }

            if (existingCommentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: parseInt(existingCommentId),
                body: commentBody,
              });
              console.log('Updated existing comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
              console.log('Created new comment');
            }
