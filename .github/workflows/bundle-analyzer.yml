name: Bundle Size Analyzer

on:
  push:
    branches: [main, master]
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Job 1: Main branch - Save stats.json to cache
  save-main-stats:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.6.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Detect changed Next.js apps
        id: changed-apps
        run: bash .github/scripts/detect-changed-apps-main.sh

      - name: Build with analysis
        env:
          ANALYZE: "true"
        run: |
          for app in ${{ steps.changed-apps.outputs.apps }}; do
            echo "Building $app..."
            app_name=$(basename $app)
            pnpm turbo build --filter="./$app" --env-mode=strict || \
            pnpm turbo build --filter="$app_name" --env-mode=strict
          done

      - name: Collect stats.json files
        id: collect-stats
        run: |
          mkdir -p bundle-stats
          has_files=false
          for app in ${{ steps.changed-apps.outputs.apps }}; do
            app_name=$(basename $app)
            if [ -f "$app/.next/stats.json" ]; then
              cp "$app/.next/stats.json" "bundle-stats/${app_name}-stats.json"
              echo "Saved stats for $app_name"
              echo "  File size: $(ls -lh "bundle-stats/${app_name}-stats.json" | awk '{print $5}')"
              # Verify the file is different for each app
              echo "  First chunk names in stats:"
              node -e "const fs=require('fs'); const s=JSON.parse(fs.readFileSync('bundle-stats/${app_name}-stats.json','utf-8')); console.log(s.chunks?.slice(0,3).map(c=>c.names?.[0]||'no-name').join(', ') || 'no chunks');" 2>/dev/null || echo "  Could not parse stats"
              has_files=true
            else
              echo "Warning: stats.json not found for $app_name at $app/.next/stats.json"
            fi
          done

          if [ "$has_files" = "true" ]; then
            echo "has_stats=true" >> $GITHUB_OUTPUT
            echo "Stats files collected:"
            ls -la bundle-stats/
            echo "File sizes:"
            for file in bundle-stats/*.json; do
              if [ -f "$file" ]; then
                echo "  $(basename $file): $(ls -lh "$file" | awk '{print $5}')"
              fi
            done
          else
            echo "has_stats=false" >> $GITHUB_OUTPUT
            echo "No stats files to cache"
          fi

      - name: Cache main branch stats
        if: steps.collect-stats.outputs.has_stats == 'true'
        uses: actions/cache@v4
        with:
          path: bundle-stats/
          key: bundle-stats-main-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            bundle-stats-main-${{ github.ref_name }}-
            bundle-stats-main-

  # Job 2: PR - Compare and comment
  compare-bundles:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: []

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.6.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Detect changed Next.js apps
        id: changed-apps
        run: |
          git fetch origin ${{ github.base_ref }}:origin/${{ github.base_ref }} || true
          bash .github/scripts/detect-changed-apps.sh "origin/${{ github.base_ref }}"

      - name: Check if any apps changed
        if: steps.changed-apps.outputs.apps == ''
        run: |
          echo "No Next.js apps changed, exiting..."
          exit 0

      - name: Get main branch commit SHA
        id: main-sha
        run: |
          git fetch origin ${{ github.base_ref }}:origin/${{ github.base_ref }} || true
          MAIN_SHA=$(git rev-parse origin/${{ github.base_ref }} 2>/dev/null || echo "")
          echo "main_sha=$MAIN_SHA" >> $GITHUB_OUTPUT
          echo "Main branch SHA: $MAIN_SHA"

      - name: Restore main branch stats from cache
        id: cache-main-stats
        uses: actions/cache@v4
        with:
          path: bundle-stats
          key: bundle-stats-main-${{ steps.main-sha.outputs.main_sha }}
          restore-keys: |
            bundle-stats-main-

      - name: Check if main stats cached
        id: check-stats
        run: |
          # Copy from bundle-stats to main-stats for consistency
          mkdir -p main-stats
          if [ -d "bundle-stats" ] && [ "$(ls -A bundle-stats 2>/dev/null)" ]; then
            echo "Found bundle-stats directory with files:"
            ls -la bundle-stats/
            cp bundle-stats/*.json main-stats/ 2>/dev/null || true
            echo "Copied to main-stats:"
            ls -la main-stats/
            echo "has_main_stats=true" >> $GITHUB_OUTPUT
            echo "âœ“ Main branch stats found from cache"
          else
            echo "has_main_stats=false" >> $GITHUB_OUTPUT
            echo "â„¹ Main branch stats not found in cache - will build main branch for comparison"
          fi

      - name: Build main branch for comparison
        if: steps.check-stats.outputs.has_main_stats != 'true'
        run: |
          bash .github/scripts/build-main-branch.sh "${{ github.base_ref }}" "${{ steps.changed-apps.outputs.apps }}"

      - name: Cache main branch stats (if built)
        if: steps.check-stats.outputs.has_main_stats != 'true'
        run: |
          # Copy from main-stats to bundle-stats for caching
          mkdir -p bundle-stats
          cp main-stats/*.json bundle-stats/ 2>/dev/null || true

      - name: Save main branch stats to cache (if built)
        if: steps.check-stats.outputs.has_main_stats != 'true'
        uses: actions/cache@v4
        with:
          path: bundle-stats
          key: bundle-stats-main-${{ steps.main-sha.outputs.main_sha }}
          restore-keys: |
            bundle-stats-main-

      - name: Verify main stats
        id: verify-stats
        run: |
          if [ -d "main-stats" ] && [ "$(ls -A main-stats 2>/dev/null)" ]; then
            echo "has_main_stats=true" >> $GITHUB_OUTPUT
          else
            echo "has_main_stats=false" >> $GITHUB_OUTPUT
          fi

      - name: Build PR branch with analysis
        env:
          ANALYZE: "true"
        run: |
          pnpm install
          for app in ${{ steps.changed-apps.outputs.apps }}; do
            echo "Building $app..."
            app_name=$(basename $app)
            pnpm turbo build --filter="./$app" --env-mode=strict || \
            pnpm turbo build --filter="$app_name" --env-mode=strict
          done

      - name: Compare bundles and generate report
        id: compare
        run: |
          bash .github/scripts/compare-bundles.sh \
            "${{ steps.changed-apps.outputs.apps }}" \
            "${{ steps.verify-stats.outputs.has_main_stats }}"

      - name: Find existing comment
        if: steps.compare.outputs.has_comparison == 'true'
        uses: actions/github-script@v7
        id: find-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // Find bot comment that contains "Bundle Size Comparison"
            const botComment = comments.find(
              (comment) =>
                comment.user.type === 'Bot' &&
                comment.body.includes('ðŸ“¦ Bundle Size Comparison')
            );

            if (botComment) {
              core.setOutput('result', botComment.id.toString());
              console.log(`Found existing comment: ${botComment.id}`);
            } else {
              core.setOutput('result', '');
              console.log('No existing comment found');
            }

      - name: Create or update PR comment
        if: steps.compare.outputs.has_comparison == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read comparison from file to avoid YAML/JavaScript escaping issues
            let commentBody = '';
            try {
              const comparisonDir = 'comparison-results';
              if (fs.existsSync(comparisonDir)) {
                const comparisonFiles = fs.readdirSync(comparisonDir);
                for (const file of comparisonFiles) {
                  if (file.endsWith('.md')) {
                    const content = fs.readFileSync(
                      path.join(comparisonDir, file),
                      'utf-8'
                    );
                    if (commentBody) {
                      commentBody += '\n\n---\n\n' + content;
                    } else {
                      commentBody = content;
                    }
                  }
                }
              }
            } catch (error) {
              console.log('Error reading comparison files:', error.message);
              return;
            }

            if (!commentBody || !commentBody.trim()) {
              console.log('No comment body to post');
              return;
            }

            const existingCommentId = '${{ steps.find-comment.outputs.result }}'.trim();

            if (existingCommentId) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: parseInt(existingCommentId),
                body: commentBody,
              });
              console.log(`Updated existing comment: ${existingCommentId}`);
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
              console.log('Created new comment');
            }
