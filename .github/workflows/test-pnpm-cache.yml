name: Test pnpm Store Cache

on:
  workflow_dispatch:
    inputs:
      push-to-ecr:
        description: "Push image to ECR (optional)"
        required: false
        default: "false"
        type: boolean
  push:
    branches:
      - main
    paths:
      - "package.json"
      - "pnpm-lock.yaml"
      - ".github/workflows/test-pnpm-cache.yml"
      - "dockerfiles/test-pnpm-cache.dockerfile"

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: test-pnpm-cache

permissions:
  id-token: write
  contents: read

jobs:
  test-pnpm-cache:
    name: ğŸ§ª Test pnpm Store Cache
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Cache pnpm store
        id: pnpm-cache
        uses: actions/cache@v3
        with:
          path: pnpm
          key: ${{ runner.os }}-pnpm-test-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-test-

      - name: Inject cache into Docker
        uses: reproducible-containers/buildkit-cache-dance@v3
        with:
          cache-map: |
            {
              "pnpm": "/pnpm"
            }
          builder: ${{ steps.buildx.outputs.name }}

      - name: Build Docker image (with pnpm install)
        id: docker-build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./dockerfiles/test-pnpm-cache-multistage.dockerfile
          tags: |
            test-pnpm-cache:latest
          # outputs: type=docker,dest=/tmp/test-image.tar

      - name: Extract cache from Docker
        id: extract-cache
        uses: reproducible-containers/buildkit-cache-dance@v3
        with:
          cache-map: |
            {
              "pnpm": "/pnpm"
            }
          builder: ${{ steps.buildx.outputs.name }}

      - name: Verify extracted cache size
        run: |
          echo "=== Verifying extracted cache ==="
          if [ -d "pnpm" ]; then
            CACHE_SIZE_BYTES=$(du -sb pnpm 2>/dev/null | cut -f1)
            CACHE_SIZE=$(du -sh pnpm 2>/dev/null | cut -f1)
            CACHE_FILES=$(find pnpm -type f 2>/dev/null | wc -l)
            echo "Cache directory exists"
            echo "Cache size: $CACHE_SIZE ($CACHE_SIZE_BYTES bytes)"
            echo "Cache files: $CACHE_FILES"
            
            # ë¹ˆ ìºì‹œì¸ì§€ í™•ì¸ (256 bytes ì´í•˜ ë˜ëŠ” íŒŒì¼ì´ ê±°ì˜ ì—†ìŒ)
            if [ "$CACHE_SIZE_BYTES" -le 1024 ] || [ "$CACHE_FILES" -lt 10 ]; then
              echo "âŒ WARNING: Extracted cache is empty or very small!"
              echo "This indicates the failure scenario is working correctly"
              echo "The cache extraction 'succeeded' but extracted an empty cache"
              echo "This happens when the final stage uses a different cache ID or no cache mount"
            else
              echo "âœ… Cache has content ($CACHE_SIZE_BYTES bytes, $CACHE_FILES files)"
              echo "This indicates the cache extraction is working correctly"
            fi
          else
            echo "âŒ Cache directory does not exist"
            echo "Cache extraction may have failed"
          fi

      - name: Clean up temporary build image file
        if: always()
        run: |
          if [ -f /tmp/test-image.tar ]; then
            echo "Removing temporary build image file to free up disk space..."
            rm -f /tmp/test-image.tar
            echo "Temporary file removed"
          fi
